let sampleJson = {
        "fontFamily":"Helvetica",
        "fontSize":14,
        "color":"#0072b1",
        "resumeSection":{
            "gap": 8,
            "headerRelativeFontSize":1.25,
            "headerUpperCase":true
        },
        "resumeSubSection":{
            "gap": 8,
            "titleRelativeFontSize":1.25,
            "subTitleRelativeFontSize":1.25
        },
        "name":{
            "text":"Name",
            "relativeFontSize":2.25,
            "bold":true,
            "italics":false
        },
        "title":{
            "text":"",
            "relativeFontSize":1.25,
            "bold":false,
            "italics":false
        },    
        "contact_info":{
            "email":"email@gmail.com",
            "phone":"+1 (000) 000-0000",
            "location":"City",
            "github":"github-id",
            "linkedin":"linkedin-id"
        },
        "sections":[
            {
                "title":{
                    "text":"Work Experience",
                    "bold":true,
                    "italics":false
                },
                "sub_sections":[
                    {
                        "heading":{
                            "left":{
                                "text":"Company 1",
                                "bold":true,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"Location",
                                "bold":true,
                                "italics":false
                            }
                        },
                        "sub_heading":{
                            "left":{
                                "text":"Job Title",
                                "bold":false,
                                "italics":true
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"Time Period",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "desc":"Job desc, duties, etc -etc - etc",
                        "bullets":true,
                        "twoColumn": false,
                        "points":[
                            "bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point.",
                            "bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point.",
                            "bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point.",
                            "bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point."
                        ]
                    },
                    {
                        "heading":{
                            "left":{
                                "text":"Company 2",
                                "bold":true,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"Location",
                                "bold":true,
                                "italics":false
                            }
                        },
                        "sub_heading":{
                            "left":{
                                "text":"Job Title",
                                "bold":false,
                                "italics":true
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"Time Period",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "desc":"Job desc, duties, etc -etc - etc",
                        "bullets":true,
                        "twoColumn": false,
                        "points":[
                            "bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point.",
                            "bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point.",
                            "bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point.",
                            "bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point - bullet point."
                        ]
                    }
                ]
            },
            {
                "title":{
                    "text":"Skills",
                    "bold":true,
                    "italics":false
                },
                "sub_sections":[
                    {
                        "heading":{
                            "left":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "sub_heading":{
                            "left":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "desc":"",
                        "bullets":false,
                        "twoColumn": true,
                        "points":[
                            "<b>Col:</b> Skills skills skills skills skills",
                            "<b>Col:</b> Skills skills skills skills skills"
                        ]
                    }
                ]
            },
            {
                "title":{
                    "text":"Projects",
                    "bold":true,
                    "italics":false
                },
                "sub_sections":[
                    {
                        "heading":{
                            "left":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "sub_heading":{
                            "left":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "desc":"",
                        "bullets":true,
                        "twoColumn": false,
                        "points":[
                            "Project description - achievement. Project description - achievement. Project description - achievement. Project description - achievement. Project description - achievement.",
                            "Project description - achievement. Project description - achievement. Project description - achievement. Project description - achievement. Project description - achievement."
                        ]
                    }
                ]
            },
            {
                "title":{
                    "text":"Education",
                    "bold":true,
                    "italics":false
                },
                "sub_sections":[
                    {
                        "heading":{
                            "left":{
                                "text":"Institute 1",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"Degree",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"Location",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "sub_heading":{
                            "left":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "desc":"",
                        "bullets":true,
                        "twoColumn": false,
                        "points":[
                            "achievements at institute. achievements at institute. achievements at institute. achievements at institute.",
                            "achievements at institute. achievements at institute. achievements at institute. achievements at institute."
                        ]
                    },
                    {
                        "heading":{
                            "left":{
                                "text":"Institute 2",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"Degree",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"Location",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "sub_heading":{
                            "left":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "desc":"",
                        "bullets":true,
                        "twoColumn": false,
                        "points":[
                            "achievements at institute. achievements at institute. achievements at institute. achievements at institute.",
                            "achievements at institute. achievements at institute. achievements at institute. achievements at institute."
                        ]
                    }
                ]
            },
            {
                "title":{
                    "text":"Publications",
                    "bold":true,
                    "italics":false
                },
                "sub_sections":[
                    {
                        "heading":{
                            "left":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "sub_heading":{
                            "left":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "center":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            },
                            "right":{
                                "text":"",
                                "bold":false,
                                "italics":false
                            }
                        },
                        "desc":"",
                        "bullets":true,
                        "twoColumn": false,
                        "points":[
                            "Publications - publications - Publications - publications - Publications - publications - Publications - publications - Publications - publications",
                            "Publications - publications - Publications - publications - Publications - publications - Publications - publications - Publications - publications"
                        ]
                    }
                ]
            }
        ]
    };

let resizeTimer;

function showHelp(){
	window.open("https://youtu.be/peUrAsUpuuo", "_blank");
}

function windowResize(){
    if(resizeTimer){
        clearTimeout(resizeTimer);
    }
    resizeTimer = setTimeout(updateResume, 50);
}

function saveToPdf(){
    let bodyElem = d3.select('body'),
        resumeElem = d3.select('#resume_outer_div'),
        jsonContent = getJsonFromForm(),
        restorePage = bodyElem.html(),
        radioFitVal = d3.select('#radio_fit').property('checked'),
        radioActualVal = d3.select('#radio_actual').property('checked'),
        printContent;
    
    if(radioFitVal){
        // get resume in actual size
        updateResume(1);
    }
    
    printContent = resumeElem.html();
    bodyElem.selectAll("*").remove();
    bodyElem.html(printContent);
    window.print();
    bodyElem.html(restorePage);

    // re-set values in form
    d3.select('#radio_fit').property('checked', radioFitVal);
    d3.select('#radio_actual').property('checked', radioActualVal);
    createFormFromJson(jsonContent);
    updateResume();
}

function jsonFileUpload(inputElem){
	fileReader = new FileReader();
    fileReader.readAsText(inputElem.files[0]);
    fileReader.onload = function(e){
        createFormFromJson(JSON.parse(fileReader.result));
        updateResume();
	};    
}

function saveJSON(){
    let jsonData = JSON.stringify(getJsonFromForm(), null, '\t');
    let file = new Blob([jsonData], {type: 'json'});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, 'resume.json');
    else { // Others
        var a = document.createElement("a"),
                url = URL.createObjectURL(file);
        a.href = url;
        a.download = 'resume.json';
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);  
        }, 0); 
    }
}

function createToolbar(parentElem, type){
    let newDiv = parentElem.append('div').attr('class', 'w100p flex_container p5 mt-10');
    newDiv.append('div').attr('class', 'w75p');

    newDiv = newDiv.append('div').attr('class', 'w25p flex_container toolbar')
                    .style('color', type === 'Section'? '#0e4a7d':'#f3a533'); // 17a3e4 d087ef f3a533

    newDiv.append('div').attr('class', 'w15p flex_end').append('span')
                                                        .attr('class', 'db mla mr0 fa fa-arrow-up')
                                                        .attr('title', 'Move ' + type + ' Up')
                                                        .datum({'type':type, 'move':'up'})
                                                        .on('click', moveUpDown);
    newDiv.append('div').attr('class', 'w15p flex_end').append('span')
                                                        .attr('class', 'db mla mr0 fa fa-arrow-down')
                                                        .datum({'type':type, 'move':'down'})
                                                        .attr('title', 'Move ' + type + ' Down')
                                                        .on('click', moveUpDown);
    newDiv.append('div').attr('class', 'w15p flex_end').append('span')
                                                        .attr('class', 'db mla mr0 fa fa-sort')
                                                        .datum({'type':type, 'move':'down'})
                                                        .attr('title', 'Expand/ Collapse ' + type)
                                                        .on('click', expandCollapse);
    newDiv.append('div').attr('class', 'w40p');
    newDiv.append('div').attr('class', 'w15p flex_end').append('span').attr('class', 'db mla mr-5 fa fa-times-circle')
            .datum({'type':type}).attr('title', 'Remove ' + type).on('click', removePart);
}

function createSubSectionPart(elemSelection, jsonData){
    let formSubSection, collapsibleSection, newDiv, moreNewDiv;

    formSubSection = elemSelection.append('div').attr('class', 'form_sub_section flex_container');
    createToolbar(formSubSection, 'Sub-Section');
    
    formSubSection.append('p').attr('class', 'w100p').html('Heading');
    newDiv = formSubSection.append('div').attr('class', 'w30p flex_container');
    newDiv.append('input').attr('class', 'w100p sub_section_heading_left').property('placeholder', 'Left')
            .property('value', jsonData.heading.left.text)

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Bold');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_heading_left_bold')
                .property('checked', jsonData.heading.left.bold);

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Italics');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_heading_left_italics')
                .property('checked', jsonData.heading.left.italics);
    
    // empty div for spacing
    formSubSection.append('div').attr('class', 'w5p');
    newDiv = formSubSection.append('div').attr('class', 'w30p flex_container');
    newDiv.append('input').attr('class', 'w100p sub_section_heading_center').property('placeholder', 'Center')
            .property('value', jsonData.heading.center.text)

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Bold');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_heading_center_bold')
                .property('checked', jsonData.heading.center.bold);

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Italics');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_heading_center_italics')
                .property('checked', jsonData.heading.center.italics);
    
    // empty div for spacing
    formSubSection.append('div').attr('class', 'w5p');
    newDiv = formSubSection.append('div').attr('class', 'w30p flex_container');
    newDiv.append('input').attr('class', 'w100p sub_section_heading_right').property('placeholder', 'Right')
            .property('value', jsonData.heading.right.text)

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Bold');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_heading_right_bold')
                .property('checked', jsonData.heading.right.bold);

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Italics');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_heading_right_italics')
                .property('checked', jsonData.heading.right.italics);

    collapsibleSection = formSubSection.append('div').attr('class', 'w100p flex_container collapsible');

    collapsibleSection.append('p').attr('class', 'mt10 w100p').html('Sub-Heading');

    newDiv = collapsibleSection.append('div').attr('class', 'w30p flex_container');
    newDiv.append('input').attr('class', 'w100p sub_section_sub_heading_left').property('placeholder', 'Left')
            .property('value', jsonData.sub_heading.left.text)

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Bold');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_sub_heading_left_bold')
                .property('checked', jsonData.sub_heading.left.bold);

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Italics');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_sub_heading_left_italics')
                .property('checked', jsonData.sub_heading.left.italics);
    
    // empty div for spacing
    collapsibleSection.append('div').attr('class', 'w5p');
    newDiv = collapsibleSection.append('div').attr('class', 'w30p flex_container');
    newDiv.append('input').attr('class', 'w100p sub_section_sub_heading_center')
            .property('placeholder', 'Center').property('value', jsonData.sub_heading.center.text)

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Bold');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_sub_heading_center_bold')
                .property('checked', jsonData.sub_heading.center.bold);

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Italics');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_sub_heading_center_italics')
                .property('checked', jsonData.sub_heading.center.italics);
    
    // empty div for spacing
    collapsibleSection.append('div').attr('class', 'w5p');
    newDiv = collapsibleSection.append('div').attr('class', 'w30p flex_container');
    newDiv.append('input').attr('class', 'w100p sub_section_sub_heading_right').property('placeholder', 'Right')
            .property('value', jsonData.sub_heading.right.text)

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Bold');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_sub_heading_right_bold')
                .property('checked', jsonData.sub_heading.right.bold);

    moreNewDiv =  newDiv.append('div').attr('class', 'w50p');
    moreNewDiv.append('span').html('Italics');
    moreNewDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_sub_heading_right_italics')
                .property('checked', jsonData.sub_heading.right.italics);


    collapsibleSection.append('p').attr('class', 'w100p mt10').html('Description');
    collapsibleSection.append('textarea').attr('class', 'w100p h50 sub_section_desc').property('value', jsonData.desc);

    collapsibleSection.append('p').attr('class', 'w100p mt10').html('Points');

    newDiv = collapsibleSection.append('div').attr('class', 'w50p');
    newDiv.append('span').html('Show Bullets');
    newDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_show_bullets')
            .property('checked', jsonData.bullets);

    newDiv = collapsibleSection.append('div').attr('class', 'w50p');
    newDiv.append('span').html('Two Columns');
    newDiv.append('input').attr('type', 'checkbox').attr('class', 'sub_section_two_columns')
            .property('checked', jsonData.twoColumn);

    collapsibleSection.append('textarea').attr('class', 'w100p h100 sub_section_points')
                    .property('value', jsonData.points.join('\n'));

    return formSubSection;
}

function createSectionPart(elemSelection, jsonData){
    let formSection, collapsibleSection, newDiv;

    formSection = elemSelection.append('div').attr('class', 'indent_1 form_section flex_container');

    createToolbar(formSection, 'Section');

    formSection.append('p').attr('class','w20p').html('Title');
    formSection.append('input').attr('class','w80p section_title').property('value', jsonData.title.text);                
    
    // empty div
    formSection.append('div').attr('class','w20p');
    newDiv = formSection.append('div').attr('class', 'w40p');

    newDiv.append('span').html('Bold');
    newDiv.append('input').attr('type', 'checkbox').attr('class','section_title_bold')
            .property('checked', jsonData.title.bold);

    newDiv = formSection.append('div').attr('class', 'w40p');
    newDiv.append('span').html('Italics');
    newDiv.append('input').attr('type', 'checkbox').attr('class','section_title_italics')
            .property('checked', jsonData.title.italics);

    collapsibleSection = formSection.append('div').attr('class', 'w100p flex_container collapsible');
    // add sub-section options
    formSubSectionHeader = collapsibleSection.append('div').attr('class', 'form_sub_section_header w100p flex_container');
    formSubSectionHeader.append('p').attr('class', 'w90p').html('Sub-Sections');
    formSubSectionHeader.append('div').attr('class', 'w10p flex_end')
                            .append('div').attr('class', 'mr0 mla')
                                .append('span')
                                    .style('font-size', 18)
                                    .attr('class', 'fa fa-plus-circle')
                                    .datum({type:'Sub-Section'})
                                    .on('click', addPart);

    jsonData.sub_sections.forEach(function(subSection){
        createSubSectionPart(collapsibleSection, subSection);
    });

    addChangeEventListeners(formSection);
    return formSection;
}

function addPart(d){
    let elemSelection, newElem;
    let emptySubSection = {
        "heading":{
            "left":{
                "text":"",
                "bold":false,
                "italics":false
            },
            "center":{
                "text":"",
                "bold":false,
                "italics":false
            },
            "right":{
                "text":"",
                "bold":false,
                "italics":false
            }
        },
        "sub_heading":{
            "left":{
                "text":"",
                "bold":false,
                "italics":false
            },
            "center":{
                "text":"",
                "bold":false,
                "italics":false
            },
            "right":{
                "text":"",
                "bold":false,
                "italics":false
            }
        },
        "desc":"",
        "bullets":true,
        "twoColumn": false,
        "points":[]
    };
    let emptySection = {
        "title":{
            "text":"",
            "bold":false,
            "italics":false
        },
        "sub_sections":[emptySubSection]
    };
    if(d.type === 'Section'){
        elemSelection = d3.select('#resume_form_div');
        newElem =  createSectionPart(elemSelection, emptySection);
    }else{
        elemSelection = d3.select(this.closest('.form_section'));
        newElem = createSubSectionPart(elemSelection, emptySubSection);
        addChangeEventListeners(newElem);
    }
    newElem.node().scrollIntoView();
}

function addChangeEventListeners(parentElem){
    parentElem.selectAll('input').on('change', updateResume);
    parentElem.selectAll('select').on('change', updateResume);
    parentElem.selectAll('textarea').on('change', updateResume);
}

function removePart(d){
    let elemSelection;
    if(d.type === 'Section'){
        elemSelection = d3.select(this.closest('.form_section'));
    }else{
        elemSelection = d3.select(this.closest('.form_sub_section'));
    }

    if (confirm("Do you want to proceed with deleting this " + d.type)) {
        elemSelection.remove();
        updateResume();
    }
}

function expandCollapse(d){
    let elem, collapsibleDiv;

    if(d.type === 'Section'){
        elem = this.closest('.form_section');
    }else{
        elem = this.closest('.form_sub_section');
    }
    collapsibleDiv = d3.select(elem).select('.collapsible');
    if(collapsibleDiv.style('display') === 'flex'){
        collapsibleDiv.style('display', 'none');
    }else{
        collapsibleDiv.style('display', 'flex');
        elem.scrollIntoView();
    }
}

function moveUpDown(d){
    let parentElem, 
        elem,
        selector,
        siblings = [],
        elemIndex;

    if(d.type === 'Section'){
        parentElem = d3.select('#resume_form_div');
        elem = this.closest('.form_section');
        selector =  '.form_section';
    }else{
        parentElem = d3.select(this.closest('.collapsible'));
        elem = this.closest('.form_sub_section');
        selector =  '.form_sub_section';
    }

    // get index of this elem    
    parentElem.selectAll(selector).each(function(d, i){
        siblings.push(this);
        if(this === elem){
            elemIndex = i;
        }
    });

    if((elemIndex === 0 && d.move === 'up') || (elemIndex === siblings.length - 1 && d.move === 'down')){
        // do nothing
        return;
    }

    if(d.move === 'up'){
        parentElem.node().insertBefore(elem, siblings[elemIndex - 1]).scrollIntoView();
    }
    if(d.move === 'down'){
        parentElem.node().insertBefore(elem, siblings[elemIndex + 2]).scrollIntoView();
    }
    updateResume();
}

function createFormFromJson(json){
    let formElem = d3.select('#resume_form_div');
    let formSectionHeader, fontSelection, formSection, newDiv;
    let availableFonts = ['Alegreya', 'Archivo', 'Arvo', 'Avenir', 'B612', 'BioRhyme', 'Cairo', 'Cardo', 'Concert One', 'Cormorant', 'Courier', 'Crimson Text', 'Fira Sans', 'Fjalla One', 'Frank Ruhl Libre', 'Garamond', 'Helvetica', 'Inconsolata', 'Karla', 'Lato', 'Lora', 'Merriweather', 'Montserrat', 'Muli', 'Noto Sans', 'Nunito', 'Old Standard TT', 'Open Sans', 'Oswald', 'Oxygen', 'Playfair Display', 'Poppins', 'Proxima Nova', 'PT Sans', 'PT Serif', 'Rakkas', 'Roboto Mono', 'Roboto', 'Rubik', 'Space Mono', 'Spectral', 'Times New Roman', 'Times', 'Titillium Web', 'Ubuntu', 'Varela', 'Verdana', 'Vollkorn', 'Work Sans', 'Yatra One'];
    //remove everything
    formElem.selectAll("*").remove();

    // add formatting options
    formSectionHeader = formElem.append('div').attr('class', 'form_section_header');
    formSectionHeader.append('p').html('Formatting Options');

    formSection = formElem.append('div').attr('class', 'header_section flex_container');
    formSection.append('p').attr('class', 'w50p').html('Font Family');
    fontSelection = formSection.append('select').attr('class', 'w50p font_family');
    availableFonts.forEach(function(font){
        fontSelection.append('option')
                        .attr('value', font)
                        .html(font);
    });
    fontSelection.property('value', json.fontFamily);

    formSection.append('p').attr('class', 'w50p').html('Base Font Size (px)');
    formSection.append('input').attr('type', 'number').attr('class', 'number_input font_size').property('value', json.fontSize);

    formSection.append('p').attr('class', 'w50p').html('Highlight Color');
    formSection.append('input').attr('type', 'color').attr('class', 'color_input highlight_color').property('value', json.color);

    // add resume section formatting options
    formSection.append('p').attr('class', 'w100p').html('Resume Section:');

    formSection.append('p').attr('class', 'indent_1 w48p').html('Gap (px)');
    formSection.append('input').attr('type', 'number').attr('class', 'number_input section_gap').property('value', json.resumeSection.gap);

    formSection.append('p').attr('class', 'indent_1 w48p').html('Header Relative Size');
    formSection.append('input').attr('type', 'number').attr('step', '0.05').attr('class', 'number_input header_size')
                .property('value', json.resumeSection.headerRelativeFontSize);

    formSection.append('p').attr('class', 'indent_1 w48p').html('Header Upper Case');
    formSection.append('input').attr('type', 'checkbox').attr('class', 'header_upper_case')
                .property('checked', json.resumeSection.headerUpperCase);

    // add resume sub-section formatting options
    formSection.append('p').attr('class', 'w100p').html('Resume Sub-Section:');

    formSection.append('p').attr('class', 'indent_1 w48p').html('Gap (px)');
    formSection.append('input').attr('type', 'number').attr('class', 'number_input sub_section_gap')
                .property('value', json.resumeSubSection.gap);

    formSection.append('p').attr('class', 'indent_1 w48p').html('Heading Relative Size');
    formSection.append('input').attr('type', 'number').attr('step', '0.05')
                .attr('class', 'number_input sub_section_title_size')
                .property('value', json.resumeSubSection.titleRelativeFontSize);

    formSection.append('p').attr('class', 'indent_1 w48p').html('Sub-Heading Relative Font Size');
    formSection.append('input').attr('type', 'number').attr('step', '0.05')
                .attr('class', 'number_input sub_section_sub_title_size')
                .property('value', json.resumeSubSection.subTitleRelativeFontSize);

    addChangeEventListeners(formSection);

    // add header options
    formSectionHeader = formElem.append('div').attr('class', 'form_section_header');
    formSectionHeader.append('p').html('Resume Header');

    formSection = formElem.append('div').attr('class', 'header_section flex_container');

    formSection.append('p').attr('class', 'w50p').html('Name');
    formSection.append('input').attr('class', 'w50p header_name').property('value', json.name.text);

    newDiv = formSection.append('div').attr('class', 'indent_1 w48p');
    
    newDiv.append('span').attr('class', 'mr5').html('Relative Size')
    newDiv.append('input').attr('type', 'number').attr('step', '0.05').attr('class', 'number_input header_name_size')
                .property('value', json.name.relativeFontSize);

    newDiv = formSection.append('div').attr('class', 'w25p');

    newDiv.append('span').html('Bold');
    newDiv.append('input').attr('type', 'checkbox').attr('class', 'header_name_bold').property('checked', json.name.bold);

    newDiv = formSection.append('div').attr('class', 'w25p');

    newDiv.append('span').html('Italics');
    newDiv.append('input').attr('type', 'checkbox').attr('class', 'header_name_italics')
            .property('checked', json.name.italics);

    formSection.append('p').attr('class', 'w50p').html('Title/ Designation');
    formSection.append('input').attr('class', 'w50p header_title').property('value', json.title.text);

    newDiv = formSection.append('div').attr('class', 'indent_1 w48p');
    
    newDiv.append('span').attr('class','mr5').html('Relative Size')
    newDiv.append('input').attr('type', 'number').attr('step', '0.05').attr('class', 'number_input header_title_size')
                .property('value', json.title.relativeFontSize);

    newDiv = formSection.append('div').attr('class', 'w25p');

    newDiv.append('span').html('Bold');
    newDiv.append('input').attr('type', 'checkbox').attr('class', 'header_title_bold')
            .property('checked', json.title.bold);

    newDiv = formSection.append('div').attr('class', 'w25p');
    newDiv.append('span').html('Italics');
    newDiv.append('input').attr('type', 'checkbox').attr('class', 'header_title_italics')
            .property('checked', json.title.italics);

    formSection.append('p').attr('class', 'w100p').html('Contact Info');

    formSection.append('p').attr('class', 'indent_1 w48p').html('e-Mail');
    formSection.append('input').attr('class', 'w50p contact_email').property('value', json.contact_info.email);

    formSection.append('p').attr('class', 'indent_1 w48p').html('Phone');
    formSection.append('input').attr('class', 'w50p contact_phone').property('value', json.contact_info.phone);

    formSection.append('p').attr('class', 'indent_1 w48p').html('Location (City)');
    formSection.append('input').attr('class', 'w50p contact_location').property('value', json.contact_info.location);

    formSection.append('p').attr('class', 'indent_1 w48p').html('GitHub ID');
    formSection.append('input').attr('class', 'w50p contact_github').property('value', json.contact_info.github);
            
    formSection.append('p').attr('class', 'indent_1 w48p').html('linkedin ID');
    formSection.append('input').attr('class', 'w50p contact_linkedin').property('value', json.contact_info.linkedin);

    addChangeEventListeners(formSection);

    // add section options
    formSectionHeader = formElem.append('div').attr('class', 'form_section_header flex_container');
    formSectionHeader.append('p').attr('class', 'w90p').html('Sections');
    formSectionHeader.append('div').attr('class', 'w10p flex_end')
                            .append('div').attr('class', 'mr0 mla')
                                .append('span')
                                    .style('font-size', 20)
                                    .attr('class', 'fa fa-plus-circle')
                                    .datum({type:'Section'})
                                    .on('click', addPart);

    json.sections.forEach(function(section){
        createSectionPart(formElem, section);
    });
}

function bodyLoaded(){
    createFormFromJson(sampleJson);
    updateResume();
}

function getJsonFromForm(){
    let formElem = d3.select('#resume_form_div'),
        jsonToReturn = {},
        sectionData,
        subSectionData,
        formSection,
        formSubSection;

    jsonToReturn['fontSize'] = formElem.select('.font_size').property('value');
    jsonToReturn['fontFamily'] = formElem.select('.font_family').property('value');
    jsonToReturn['color'] = formElem.select('.highlight_color').property('value');

    jsonToReturn['resumeSection'] = {};
    jsonToReturn['resumeSection']['gap'] = formElem.select('.section_gap').property('value');
    jsonToReturn['resumeSection']['headerRelativeFontSize'] = formElem.select('.header_size').property('value');
    jsonToReturn['resumeSection']['headerUpperCase'] = formElem.select('.header_upper_case').property('checked');
    
    jsonToReturn['resumeSubSection'] = {};
    jsonToReturn['resumeSubSection']['gap'] = formElem.select('.sub_section_gap').property('value');
    jsonToReturn['resumeSubSection']['titleRelativeFontSize'] = formElem.select('.sub_section_title_size').property('value');
    jsonToReturn['resumeSubSection']['subTitleRelativeFontSize'] = formElem.select('.sub_section_sub_title_size').property('value');
    
    jsonToReturn['name'] = {};
    jsonToReturn['name']['text'] = formElem.select('.header_name').property('value');
    jsonToReturn['name']['relativeFontSize'] = formElem.select('.header_name_size').property('value');
    jsonToReturn['name']['bold'] = formElem.select('.header_name_bold').property('checked');
    jsonToReturn['name']['italics'] = formElem.select('.header_name_italics').property('checked');

    jsonToReturn['title'] = {};
    jsonToReturn['title']['text'] = formElem.select('.header_title').property('value');
    jsonToReturn['title']['relativeFontSize'] = formElem.select('.header_title_size').property('value');
    jsonToReturn['title']['bold'] = formElem.select('.header_title_bold').property('checked');
    jsonToReturn['title']['italics'] = formElem.select('.header_title_italics').property('checked');

    jsonToReturn['contact_info'] = {};
    jsonToReturn['contact_info']['email'] = formElem.select('.contact_email').property('value');
    jsonToReturn['contact_info']['phone'] = formElem.select('.contact_phone').property('value');
    jsonToReturn['contact_info']['location'] = formElem.select('.contact_location').property('value');
    jsonToReturn['contact_info']['github'] = formElem.select('.contact_github').property('value');
    jsonToReturn['contact_info']['linkedin'] = formElem.select('.contact_linkedin').property('value');

    jsonToReturn['sections'] = [];
    d3.selectAll('.form_section').each(function(d, i){
        formSection = d3.select(this);
        sectionData = {};
        sectionData['title'] = {};
        sectionData['title']['text'] = formSection.select('.section_title').property('value');
        sectionData['title']['bold'] = formSection.select('.section_title_bold').property('checked');
        sectionData['title']['italics'] = formSection.select('.section_title_italics').property('checked');

        sectionData['sub_sections'] = [];
        formSection.selectAll('.form_sub_section').each(function(di, ii){
            formSubSection = d3.select(this);
            subSectionData = {};
            subSectionData['heading'] = {};
            subSectionData['sub_heading'] = {};

            subSectionData['heading']['left'] = {};
            subSectionData['heading']['left']['text'] = formSubSection.select('.sub_section_heading_left').property('value');
            subSectionData['heading']['left']['bold'] = formSubSection.select('.sub_section_heading_left_bold').property('checked');
            subSectionData['heading']['left']['italics'] = formSubSection.select('.sub_section_heading_left_italics').property('checked');

            subSectionData['heading']['center'] = {};
            subSectionData['heading']['center']['text'] = formSubSection.select('.sub_section_heading_center').property('value');
            subSectionData['heading']['center']['bold'] = formSubSection.select('.sub_section_heading_center_bold').property('checked');
            subSectionData['heading']['center']['italics'] = formSubSection.select('.sub_section_heading_center_italics').property('checked');

            subSectionData['heading']['right'] = {};
            subSectionData['heading']['right']['text'] = formSubSection.select('.sub_section_heading_right').property('value');
            subSectionData['heading']['right']['bold'] = formSubSection.select('.sub_section_heading_right_bold').property('checked');
            subSectionData['heading']['right']['italics'] = formSubSection.select('.sub_section_heading_right_italics').property('checked');
            
            subSectionData['sub_heading']['left'] = {};
            subSectionData['sub_heading']['left']['text'] = formSubSection.select('.sub_section_sub_heading_left').property('value');
            subSectionData['sub_heading']['left']['bold'] = formSubSection.select('.sub_section_sub_heading_left_bold').property('checked');
            subSectionData['sub_heading']['left']['italics'] = formSubSection.select('.sub_section_sub_heading_left_italics').property('checked');

            subSectionData['sub_heading']['center'] = {};
            subSectionData['sub_heading']['center']['text'] = formSubSection.select('.sub_section_sub_heading_center').property('value');
            subSectionData['sub_heading']['center']['bold'] = formSubSection.select('.sub_section_sub_heading_center_bold').property('checked');
            subSectionData['sub_heading']['center']['italics'] = formSubSection.select('.sub_section_sub_heading_center_italics').property('checked');

            subSectionData['sub_heading']['right'] = {};
            subSectionData['sub_heading']['right']['text'] = formSubSection.select('.sub_section_sub_heading_right').property('value');
            subSectionData['sub_heading']['right']['bold'] = formSubSection.select('.sub_section_sub_heading_right_bold').property('checked');
            subSectionData['sub_heading']['right']['italics'] = formSubSection.select('.sub_section_sub_heading_right_italics').property('checked');

            subSectionData['desc'] = formSubSection.select('.sub_section_desc').property('value');
            subSectionData['bullets'] = formSubSection.select('.sub_section_show_bullets').property('checked');
            subSectionData['twoColumn'] = formSubSection.select('.sub_section_two_columns').property('checked');
            subSectionData['points'] = formSubSection.select('.sub_section_points').property('value').split('\n');
 
            sectionData['sub_sections'].push(subSectionData);
        });

        jsonToReturn['sections'].push(sectionData);
    });
    return jsonToReturn;
}

function updateResume(formFactor){
    let resumeElem = d3.select('#resume_div'),
        radioFit = d3.select('#radio_fit'),
        displayWidth,
        actualWidth,
        resumeJson = getJsonFromForm();

    // clear everything from resume elem
    resumeElem.selectAll("*").remove();

    resumeElem.style('width', '8.5in');
    actualWidth = resumeElem.node().clientWidth;

    //get form factor
    if(!formFactor && radioFit.property('checked')){
        resumeElem.style('width', '98%');
        displayWidth = resumeElem.node().clientWidth;
        formFactor = displayWidth/actualWidth;
    }else{
        formFactor = 1
    }

    //add high level formats
    resumeElem.style('font-size', resumeJson.fontSize * formFactor)
                .style('font-family', resumeJson.fontFamily);

    // add header
    let headerDiv = resumeElem.append('div').attr('id', 'header');

    headerDiv.append('p')
                .attr('id', 'resume_name')
                .style('font-size', resumeJson.fontSize * resumeJson.name.relativeFontSize * formFactor)
                .style('color', resumeJson.color)
                .style('font-weight', resumeJson.name.bold ? 'bold' : 'normal')
                .style('font-style', resumeJson.name.italics ? 'italic' : 'normal')
                .text(resumeJson.name.text);

    if(resumeJson.title.text){
        // add title
        headerDiv.append('p')
                .attr('id', 'resume_title')
                .style('font-size', resumeJson.fontSize * resumeJson.title.relativeFontSize * formFactor)
                .style('color', resumeJson.color)
                .style('font-weight', resumeJson.title.bold ? 'bold' : 'normal')
                .style('font-style', resumeJson.title.italics ? 'italic' : 'normal')
                .text(resumeJson.title.text);
    }

    // add contacts
    let contactsDiv = headerDiv.append('div').attr('id','contacts_div');
    let contactDiv;
    if(resumeJson.contact_info.email){
        contactDiv = contactsDiv.append('div').attr('class', 'contact_div');
        contactDiv.append('span')
                    .attr('class', 'envelope_icon')
                    .append('span')
                        .attr('class', 'fa fa-envelope')
                        .style('color', resumeJson.color);

        contactDiv.append('span')
                    .attr('class', 'contact')
                    .append('a')
                        .attr('href', 'mailto:' + resumeJson.contact_info.email)
                        .style('color', resumeJson.color)
                        .text(resumeJson.contact_info.email);
    }

    if(resumeJson.contact_info.phone){
        contactDiv = contactsDiv.append('div').attr('class', 'contact_div');
        contactDiv.append('span')
                    .attr('class', 'mobile_icon')
                    .append('span')
                        .attr('class', 'fa fa-mobile')
                        .style('color', resumeJson.color);

        contactDiv.append('span')
                    .attr('class', 'contact')
                    .style('color', resumeJson.color)
                    .text(resumeJson.contact_info.phone);
    }

    if(resumeJson.contact_info.location){
        contactDiv = contactsDiv.append('div').attr('class', 'contact_div');
        contactDiv.append('span')
                    .attr('class', 'map_icon')
                    .append('span')
                        .attr('class', 'fa fa-map-marker')
                        .style('color', resumeJson.color);

        contactDiv.append('span')
                    .attr('class', 'contact')
                    .style('color', resumeJson.color)
                    .text(resumeJson.contact_info.location);
    }

    if(resumeJson.contact_info.github){
        contactDiv = contactsDiv.append('div').attr('class', 'contact_div');
        contactDiv.append('span')
                    .attr('class', 'github_icon')
                    .append('span')
                        .attr('class', 'fa fa-github')
                        .style('color', resumeJson.color);

        contactDiv.append('span')
                    .attr('class', 'contact')
                    .append('a')
                        .attr('href', 'https://github.com/' + resumeJson.contact_info.github)
                        .attr('target', '_blank')
                        .style('color', resumeJson.color)
                        .text(resumeJson.contact_info.github);
    }

    if(resumeJson.contact_info.linkedin){
        contactDiv = contactsDiv.append('div').attr('class', 'contact_div');
        contactDiv.append('span')
                    .attr('class', 'envelope_icon')
                    .append('span')
                        .attr('class', 'fa fa-linkedin')
                        .style('color', resumeJson.color);

        contactDiv.append('span')
                    .attr('class', 'contact')
                    .append('a')
                        .attr('href', 'https://www.linkedin.com/in/' + resumeJson.contact_info.linkedin)
                        .attr('target', '_blank')
                        .style('color', resumeJson.color)
                        .text(resumeJson.contact_info.linkedin);
    }

    // add sections
    resumeJson.sections.forEach(function(section){
        let sectionElem = resumeElem.append('div')
                                    .attr('class', 'resume_section')
                                    .style('margin', resumeJson.resumeSection.gap * formFactor + ' 0');
        // add section header
        sectionElem.append('div').attr('class', 'section_header')
                    .append('p')
                    .style('color', resumeJson.color)
                    .style('font-weight', section.title.bold ? 'bold' : 'normal')
                    .style('font-style', section.title.italics ? 'italic' : 'normal')
                    .style('font-size', resumeJson.fontSize * resumeJson.resumeSection.headerRelativeFontSize * formFactor)
                    .style('text-transform', resumeJson.resumeSection.headerUpperCase ? 'uppercase' : 'none')
                    .text(section.title.text);

        sectionElem.append('hr').style('background-color', resumeJson.color);

        // add sub-sections
        section.sub_sections.forEach(function(subSection){
            let subSectionElem = sectionElem.append('div')
                                            .attr('class', 'section_content')
                                            .style('margin', resumeJson.resumeSubSection.gap * formFactor + ' 0');
            
            addResumeSubSectionHeading(subSectionElem, subSection.heading, resumeJson.fontSize * resumeJson.resumeSubSection.titleRelativeFontSize * formFactor);

            addResumeSubSectionHeading(subSectionElem, subSection.sub_heading, resumeJson.fontSize * resumeJson.resumeSubSection.subTitleRelativeFontSize * formFactor);

            // add sub section description
            if(subSection.desc){
                subSectionElem.append('p')
                                .text(subSection.desc);
            }

            // sub section points
            if(subSection.points){
                let bulletsDiv = subSectionElem.append('div');
                let activeDiv, firstDiv, secondDiv, ulElem, firstUl, secondUl;
                if(subSection.twoColumn){
                    bulletsDiv.style('display', 'flex');
                    firstDiv = bulletsDiv.append('div')
                                            .style('width', subSection.bullets ? '50%' : '48.5%');
                    
                    if(!subSection.bullets){
                        // for spacing
                        bulletsDiv.append('div').style('width', '3%');
                    }
                    
                    secondDiv = bulletsDiv.append('div')
                                            .style('width', subSection.bullets ? '50%' : '48.5%');                      
                }
                
                let pointsAdded = 0;
                if(subSection.bullets){
                    if(subSection.twoColumn){
                        firstUl = firstDiv.append('ul').style('padding-left', 40 * formFactor);
                        secondUl = secondDiv.append('ul').style('padding-left', 40 * formFactor);
                    }else{
                        ulElem =  bulletsDiv.append('ul').style('padding-left', 40 * formFactor);
                    }
                    subSection.points.forEach(function(point, i){
                        if(!point) return;
                        if(subSection.twoColumn){
                            ulElem = pointsAdded %2 ? secondUl : firstUl;
                        }
                        ulElem.append('li').html(point);
                        pointsAdded ++;
                    });
                }else{
                    activeDiv =  bulletsDiv;
                    subSection.points.forEach(function(point, i){
                        if(!point) return;
                        if(subSection.twoColumn){
                            activeDiv = pointsAdded%2 ? secondDiv : firstDiv;
                        }
                        activeDiv.append('p').html(point);
                        pointsAdded ++;
                    });
                }
            }
        });
    });
}

function addResumeSubSectionHeading(elemSelection, dataObj, fontSize){
    let headingPresent = dataObj.left.text || dataObj.center.text || dataObj.right.text;
    // add sub section heading
    if(headingPresent){
        let headingDiv = elemSelection.append('div').attr('class', 'flex_justify');
        let divElem, divWidth, spanElem, spanWidth

        headingDiv.append('div').attr('class', 'w33p ofv').append('span')
                        .attr('class', 'wsnw')
                        .style('font-weight', dataObj.left.bold ? 'bold' : 'normal')
                        .style('font-style', dataObj.left.italics ? 'italic' : 'normal')
                        .style('font-size', fontSize)
                        .text(dataObj.left.text);

        divElem = headingDiv.append('div').attr('class', 'w33p ofv')
        spanElem = divElem.append('span')
                            .attr('class', 'wsnw')
                            .style('display', 'inline-block')
                            .style('font-weight', dataObj.center.bold ? 'bold' : 'normal')
                            .style('font-style', dataObj.center.italics ? 'italic' : 'normal')
                            .style('text-align', 'center')
                            .style('font-size', fontSize)
                            .text(dataObj.center.text);
    
        // make sure long text is properly aligned
        divWidth = divElem.node().clientWidth;
        spanWidth = spanElem.node().clientWidth;
        if(spanWidth > divWidth){
            spanElem.style('display', 'block');
            spanElem.style('margin-left', -(spanWidth - divWidth)/2);
        }else{
            spanElem.style('display', 'block');
            spanElem.style('margin', '0 auto');
        }

        divElem = headingDiv.append('div').attr('class', 'w33p ofv');
        spanElem = divElem.append('span')
                        .attr('class', 'wsnw')
                        .style('display', 'inline-block')
                        .style('font-weight', dataObj.right.bold ? 'bold' : 'normal')
                        .style('font-style', dataObj.right.italics ? 'italic' : 'normal')
                        .style('text-align', 'right')
                        .style('font-size', fontSize)
                        .text(dataObj.right.text);
        
        // make sure long text is properly aligned
        divWidth = divElem.node().clientWidth;
        spanWidth = spanElem.node().clientWidth;
        if(spanWidth > divWidth){
            spanElem.style('display', 'block');
            spanElem.style('margin-left', -(spanWidth - divWidth));
        }else{
            spanElem.style('display', 'block');
            spanElem.style('margin-right', '0');
            spanElem.style('margin-left', 'auto');
        }
    }
}